{% extends "base/page.html" %}
{% load static %}
{% block css %}
<style>
.hide {
  display: none
}
</style>
<script src="https://code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous" integrity="sha384-xBuQ/xzmlsLoJpyjoggmTEz8OWUFM0/RC5BsqQBDX2v5cMvDHcMakNTNrHIW2I5f"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" crossorigin="anonymous" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" crossorigin="anonymous" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"></script>
{% endblock %}
{% block content %}
    <h1>Form Template for {{ project.name }}</h1>
    <hr>
    <p style="max-width:100%" class="alert alert-info">The purpose of this template is to track the progress of your project during the exploratory/planning (or pre-implementation), implementation, and sustainment phases. You will be seeing three versions of the template.  A version for exploration/planning, a version for implementation, and a version for sustainment.  When this template is on-line, these three templates will be completed when a TTC is in that particular phase.</p>
    {% if form.errors %}{% for field, error in form.errors.items %}<p class="alert alert-warning alert-dissmissable">{{ field }}: {{ error }}</p>{% endfor %}{% endif %}
    {{ form.media }}
    <form id="templateform" method="POST" class="post-form">{% csrf_token %}    
    <br>
    <h2>1. Evidence-Based Intervention/Program/Service Being Implemented (WHAT)</h2>
    <div class="form-group">
        <textarea name="name" cols="40" rows="5" class="form-control" required id="id_name">{{ form.name.value|default_if_none:"" }}</textarea> <span class="helptext">Describe your evidence-Based Intervention/Program/Service Being Implemented (WHAT)</span>
    </div>
    <div class="form-group">
        <label for="id_start_date">Project start date:</label> 
        {{ form.start_date }}
    </div>
    <div class="form-group">
        <label for="id_end_date">Project end date:</label> 
        {{ form.end_date }}
    </div>
    <hr>
    <br>
    <h2>2. Target Audience (WHO)</h2>
    <div class="form-group">
        <label for="id_target_audience_disciplines">a) Specify target audience disciplines:</label>
        <textarea name="target_audience_disciplines" cols="40" rows="5" class="form-control" required id="id_target_audience_disciplines">{{ form.target_audience_disciplines.value|default_if_none:"" }}</textarea> 
    </div>
    <div class="form-group">
        <label for="id_target_audience_roles">b) Specify roles:</label>
        <textarea name="target_audience_roles" cols="40" rows="5" class="form-control" required id="id_target_audience_roles">{{ form.target_audience_roles.value|default_if_none:"" }}</textarea>
    </div>
    <label>c) Specify audience relationship to one another (Select all that apply):</label>
    <br><br>
     <div class="form-group">
         <span style="padding-right:20px" class="helptext">Multiple individuals across organizations:</span>
         <label style="float:right" class="custom-toggle" for="id_target_audience_across_orgs">
             <input type="checkbox" name="target_audience_across_orgs" class="form-control" id="id_target_audience_across_orgs" {% if form.target_audience_across_orgs.value %}checked{% endif %}>
             <span class="custom-toggle-slider rounded-circle" data-label-off="No" data-label-on="Yes"></span>
         </label> 
    </div>

     <div class="form-group">
         <span style="padding-right:20px" class="helptext">Multiple individuals within an organization:</span>
         <label style="float:right" class="custom-toggle" for="id_target_audience_within_orgs">
             <input type="checkbox" name="target_audience_within_orgs" class="form-control" id="id_target_audience_within_orgs" {% if form.target_audience_within_org.value %}checked{% endif %}>
             <span class="custom-toggle-slider rounded-circle" data-label-off="No" data-label-on="Yes"></span>
         </label> 
    </div>
     <div class="form-group">
         <span style="padding-right:20px" class="helptext">Multiple individuals or teams across organizations:</span>
         <label style="float:right" class="custom-toggle" for="id_target_audience_teams_across_orgs">
             <input type="checkbox" name="target_audience_teams_across_orgs" class="form-control" id="id_target_audience_teams_across_orgs" {% if form.target_audience_teams_across_orgs.value %}checked{% endif %}>
             <span class="custom-toggle-slider rounded-circle" data-label-off="No" data-label-on="Yes"></span>
         </label> 
    </div>
    <hr>
    <h2>3. Implementation Strategy (HOW)</h2>
    <p>Determine which of the following best describe the implementation strategies used in your project. They may be discrete, or multicomponent, or both. Then fill in the table below with your selections.</p>
<ul class="list-group">
  <li class="list-group-item"><strong>Evaluative and iterative strategies</strong><br> (e.g., Assess for readiness; Identify barriers and facilitators; Audit and feedback)</li>
  <li class="list-group-item"><strong>Interactive assistance</strong><br> (e.g., Facilitation; Technical assistance; Coaching; Clinical Supervision; Mentoring)</li>
  <li class="list-group-item"><strong>Adapting and tailoring strategies</strong><br> (e.g., Based on barriers or facilitators; Stage of readiness; Characteristics of the Intervention; Baseline performance)</li>
  <li class="list-group-item"><strong>Develop stakeholder relationships</strong><br> (e.g., Identify and prepare champions; Inform local opinion leaders; Build coalitions)</li>
  <li class="list-group-item"><strong>Train/educate stakeholders</strong><br> (e.g., Conduct ongoing training; Develop educational materials; Learning Collaborative; Practice Improvement Collaborative)</li>
  <li class="list-group-item"><strong>Support deliverers of the intervention/program/service</strong><br> (e.g. Reminders; Resource sharing agreements; Role revision)</li>
  <li class="list-group-item"><strong>Engage consumers</strong><br> (e.g., Involve consumers and family members; Use mass media or public service announcements)</li>
  <li class="list-group-item"><strong>Use financial strategies</strong><br> (e.g., Access new funding [time-limited grant or 3rd party insurance]; Provide incentives/allowance; Develop disincentives)
</li>
  <li class="list-group-item"><strong>Change infrastructure</strong><br> (e.g., Policy mandates; Alter physical environment)</li>
</ul>
   <p>(Use strategies from above; add or delete rows if needed):</p>
   <div class="table-responsive" id="table">
    <div>
        <span class="table-add float-right mb-3 mr-2"><a href="#!" class="text-success"><i class="fa fa-plus" aria-hidden="true"></i></a></span>
        <table class="table align-items-center">
        <thead class="thead-light">
            <tr>
                <th scope="col" class="sort" data-sort="type">Type</th>
                <th scope="col" class="sort" data-sort="format">Format</th>
                <th scope="col" class="sort" data-sort="units">Planned Number of Units</th>
                <th scope="col" class="sort" data-sort="frequency">Frequency</th>
                <th scope="col"></th>
            </tr>
        </thead>
        <tbody class="list">     
            <tr class="hide">
                <td contenteditable="true" class="type">
                </td>
                <td contenteditable="true" class="format">
                </td>
                <td contenteditable="true" class="units" type="number" step="1">
                </td>
                <td contenteditable="true" class="frequency">
                </td>
                <td>
                  <span class="table-remove"><button type="button" class="btn btn-danger btn-rounded btn-sm my-0">Remove</button></span>
                </td>
            </tr>{% if strategies %}{% for strategy in strategies %}
            <tr>
                <td contenteditable="true" class="type">{{ strategy.strategy_type }}
                </td>
                <td contenteditable="true" class="format">{{ strategy.strategy_format }}
                </td>
                <td contenteditable="true" class="units" type="number" step="1">{{ strategy.planned_number_units }}
                </td>
                <td contenteditable="true" class="frequency">{{ strategy.frequency }}
                </td>
                <td>
                  <span class="table-remove"><button type="button" class="btn btn-danger btn-rounded btn-sm my-0">Remove</button></span>
                </td>
            </tr>{% endfor %}{% else %}
            <tr>
                <td contenteditable="true" class="type">
                </td>
                <td contenteditable="true" class="format">
                </td>
                <td contenteditable="true" class="units" type="number" step="1">
                </td>
                <td contenteditable="true" class="frequency">
                </td>
                <td>
                  <span class="table-remove"><button type="button" class="btn btn-danger btn-rounded btn-sm my-0">Remove</button></span>
                </td>
            </tr>{% endif %}
        </table>
        </div>
    </div>
    <div class="form-group">
        <label for="id_implement_strategy_description">Implement strategy description:</label>
        <textarea name="implement_strategy_description" cols="40" rows="5" class="form-control" required id="id_implement_strategy_description">{{ form.implement_strategy_description.value|default_if_none:"" }}</textarea> <span class="helptext">Free Text Description (Provide a Description of the Planned Implementation Steps)</span>
    </div>

    <hr>
    <br>
    <h2>4. Contextual/determinant Considerations</h2>
    <p>(What facilitators {% if project.stage == 1 %}are anticipated{% elif project.stage == 2 %}are present{% else %}were present{% endif %} to aid implementation and barriers that {% if project.stage == 1 %} could hinder{% elif project.stage == 2 %}have hindered{% else %} hindered{% endif %} implementation?)</p>
    <div class="form-group">
        <label for="id_consider_system_factors">Consider system factors:</label>
        <textarea name="consider_system_factors" cols="40" rows="5" class="form-control" required id="id_consider_system_factors">{{ form.consider_system_factors.value|default_if_none:"" }}</textarea>
         <span class="helptext">System factors--external to the organization (e.g., financing; mandates, community, culture)</span>
    </div>
    <div class="form-group">
        <label for="id_consider_org_factors">Consider organizational factors:</label> 
        <textarea name="consider_org_factors" cols="40" rows="5" class="form-control" required id="id_consider_org_factors">{{ form.consider_org_factors.value|default_if_none:"" }}</textarea> 
        <span class="helptext">Organizational factorsâ€”internal to the organization (e.g., leadership; readiness)</span>
    </div>
    <div class="form-group">
        <label for="id_consider_clinical_factors">Consider clinical factors:</label>
        <textarea name="consider_clinical_factors" cols="40" rows="5" class="form-control" required id="id_consider_clinical_factors">{{ form.consider_clinical_factors.value|default_if_none:"" }}</textarea>
        <span class="helptext">Individual clinician factors (e.g., alignment with existing practice; complexity)</span>
    </div>
    {% if project.stage > 1 %}<div class="form-group">
	<label for="id_consider_sustainment_strategy">Consider sustainment strategy:</label>
	<textarea name="consider_sustainment_strategy" cols="40" rows="5" class="form-control" required id="id_consider_sustainment_strategy">{{ form.consider_sustainment_strategy.value|default_if_none:"" }}</textarea>
        <span class="helptext">Sustainment strategies applied</span>
    </div>{% endif %}
    <hr>
    <br>
    <h2>5. Implementation Process</h2>
    <div class="form-group">
        <label for="id_implementation_recruited">Implementation recruited:</label> 
        <textarea name="implementation_recruited" cols="40" rows="5" class="form-control" required id="id_implementation_recruited">{{ form.implementation_recruited.value|default_if_none:"" }}</textarea>
        <span class="helptext">a) How will participants be recruited?</span>
    </div>
    {% if project.stage > 1 %}<div class="form-group">
        <label for="id_implementation_participants">Implementation participants:</label> 
        <input value='{{ form.implementation_participants.value|default_if_none:"0" }}' step="1" type="number" name="implementation_participants" min="0" class="form-control" required id="id_implementation_participants"> 
        <span class="helptext">b) How many participants are enrolled?</span>
    </div>
    <div class="form-group">
        <label for="id_implementation_enrolled">Implementation enrolled:</label> 
        <input value='{{ form.implementation_enrolled.value|default_if_none:"0" }}' type="number" name="implementation_enrolled" min="0" class="form-control" step="1" required id="id_implementation_enrolled"> 
        <span class="helptext">c) # (%) initiating implementation strategy (individuals, teams or organizations</span>
    </div>{% endif %}

    {% if project.stage > 2 %}<div class="form-group">
        <label for="id_implementation_completing_half">Implementation completing half:</label>
        <input type="number" value='{{ form.implementation_completing_half.value|default_if_none:"0" }}' name="implementation_completing_half" min="0" class="form-control" required id="id_implementation_completing_half"> 
        <span class="helptext"># (%) completing 50% of implementation strategy activities</span>
    </div>
    <div class="form-group">
        <label for="id_implementation_completing_majority">Implementation completing majority:</label>
        <input type="number" value='{{ form.implementation_completing_majority.value|default_if_none:"0" }}' name="implementation_completing_majority" min="0" class="form-control" required id="id_implementation_completing_majority">
        <span class="helptext"># (%) completing 80% or more of implementation strategy activities</span>
    </div>{% endif %}

    <hr>
    <br>
    <h2>6. What Implementation/Sustainment Measures are being {% if project.stage == 1 %}planned{% else %}collected{% endif %}?</h2>
    <div class="table-responsive">
    <div>
        <table class="align-items-center">
        <thead class="thead-light">
            <tr>
                <th scope="col" class="sort" data-sort="outcome">Outcome</th>
                <th scope="col" class="sort" data-sort="measure">How {% if project.stage == 1 %}will{% else %}did{% endif %} you measure the outcome?</th>
                {% if project.stage > 1 %}<th scope="col" class="sort" data-sort="results">Results</th>{% endif %}
            </tr>
        </thead>
        <tbody class="list">     
            <tr>
                <td class="outcome">a) Reach (# or percentage of population, what is the population, and how will you be measuring the outcome?</td>
                <td contenteditable="true" class="measure">
		    <div class="form-group">
		        <textarea name="outcome_reach" cols="40" rows="5" class="form-control" required id="id_outcome_reach">{{ form.outcome_reach.value|default_if_none:"" }}</textarea>
		     </div>
                </td>
                {% if project.stage > 1 %}<td contenteditable="true" class="results">
		  <div class="form-group">
                      <textarea name="results_reach" cols="40" rows="5" class="form-control" required id="id_results_reach">{{ form.results_reach.value|default_if_none:"" }}</textarea>
		   </div>
                </td>{% endif %}
            </tr>

            <tr>
                <td class="outcome">b) Effectiveness of Intervention/Program/Services (w/consumers), how do you measure it?</td>
                <td contenteditable="true" class="measure">
		    <div class="form-group">
			 <textarea name="outcome_effectiveness" cols="40" rows="5" class="form-control" required id="id_outcome_effectiveness">{{ form.outcome_effectiveness.value|default_if_none:"" }}</textarea>
		    </div>
                </td>
                {% if project.stage > 1 %}<td contenteditable="true" class="results">
		    <div class="form-group"><textarea name="results_effectiveness" cols="40" rows="5" class="form-control" required id="id_results_effectiveness">{{ form.results_effectiveness.value|default_if_none:"" }}</textarea>
		</div>
                </td>{% endif %}
            </tr>

            <tr>
                <td class="outcome">c) Adoption (#/% of providers)</td>
                <td contenteditable="true" class="measure">
		    <div class="form-group">
			<textarea name="outcome_adoption" cols="40" rows="5" class="form-control" required id="id_outcome_adoption">{{ form.outcome_adoption.value|default_if_none:"" }}</textarea>
		    </div>
                </td>
                {% if project.stage > 1 %}<td contenteditable="true" class="results">
		<div class="form-group"><textarea name="results_adoption" cols="40" rows="5" class="form-control" required id="id_results_adoption">{{ form.results_adoption.value|default_if_none:"" }}</textarea>
		</div>
                </td>{% endif %}
            </tr>

            <tr>
                <td class="outcome">d) Implementation Fidelity/Adherence/Quality</td>
                <td contenteditable="true" class="measure">
		    <div class="form-group"><textarea name="outcome_quality" cols="40" rows="5" class="form-control" required id="id_outcome_quality">{{ form.outcome_quality.value|default_if_none:"" }}</textarea>
		    </div>
                </td>
                {% if project.stage > 1 %}<td contenteditable="true" class="results">
		<div class="form-group"><textarea name="results_quality" cols="40" rows="5" class="form-control" required id="id_results_quality">{{ form.results_quality.value|default_if_none:"" }}</textarea> 
			</div>
                </td>{% endif %}
            </tr>
            <tr>
                <td class="outcome">e) Cost</td>
                <td contenteditable="true" class="measure">
		    <div class="form-group"><textarea name="outcome_cost" cols="40" rows="5" class="form-control" required id="id_outcome_cost">{{ form.outcome_cost.value|default_if_none:"" }}</textarea>
		    </div>
                </td>
                {% if project.stage > 1 %}<td contenteditable="true" class="results">
		<div class="form-group"><textarea name="results_cost" cols="40" rows="5" class="form-control" required id="id_results_cost">{{ form.results_cost.value|default_if_none:"" }}</textarea>
		</div>
                </td>{% endif %}
            </tr>
            {% if project.stage > 2 %}<tr>
                <td class="outcome">f) Maintenance/Sustainment</td>
                <td contenteditable="true" class="measure">
		    <div class="form-group"><textarea name="outcome_maintenance" cols="40" rows="5" class="form-control" required id="id_outcome_maintenance">{{ form.outcome_maintenance.value|default_if_none:"" }}</textarea>
		    </div>
                </td>
                <td contenteditable="true" class="results">
		<div class="form-group"><textarea name="results_maintenance" cols="40" rows="5" class="form-control" required id="id_results_maintenance">{{ form.results_maintenance.value|default_if_none:"" }}</textarea>
		</div>
                </td>
            </tr>{% endif %}
            <tr>
                <td class="outcome">{% if project.stage < 3 %}f){% else %}g){% endif %} Any other measures?</td>
                <td contenteditable="true" class="measure">
		    <div class="form-group"><textarea name="outcome_other" cols="40" rows="5" class="form-control" id="id_outcome_other">{{ form.outcome_other.value|default_if_none:"" }}</textarea>
		    </div>
                </td>
                {% if project.stage > 1 %}<td contenteditable="true" class="results">
		<div class="form-group"><textarea name="results_other" cols="40" rows="5" class="form-control" id="id_results_other">{{ form.results_other.value|default_if_none:"" }}</textarea>
		</div>
                </td>{% endif %}
            </tr>

    </table>
    </div>
    </div>

        <button type="submit" class="save btn btn-default">Save</button>
    </form>
{% endblock %}
{% block scripts %}
<script>
var $TABLE = $('#table');

$("#templateform").submit(function(event){
    event.preventDefault()
    var form = $(this).closest('form');
    form = form.serializeArray();

     var $rows = $TABLE.find('tr:not(:hidden)');
     var data = [];

     // Turn all existing rows into a loopable array
     count = 0
     $rows.each(function () {
        var $td = $(this).find('td');
        console.log($td)

        // Use the headers from earlier to name our hash keys
        $td.each(function (i, col) {
            var classname = $(col).attr("class")
            if ((classname != "") && (classname != undefined)) {
                data.push({name: "strategy_" + classname + "_" + count, value: $(col).text()})
            }
        });
        count+=1
     });

    form = form.concat(data)
    $.post('', form, function(d) {
        if (d.error) {
           alert("There was a problem updating your user details")
        } 
        console.log(d);
    });

    // Output the result
    console.log(JSON.stringify(data));

})

$('.table-add').click(function () {
  var $clone = $TABLE.find('tr.hide').clone(true).removeClass('hide');
  $TABLE.find('table').append($clone);
});

$('.table-remove').click(function () {
  $(this).parents('tr').detach();
});
</script>
{% endblock %}
